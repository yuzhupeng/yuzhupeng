## ğŸ“Š ç´¢å¼•çš„ä»£ä»·ï¼ˆä¸ºä»€ä¹ˆä¸èƒ½å¤šï¼‰

### **1\. å†™å…¥æ€§èƒ½æ€¥å‰§ä¸‹é™**

```highlighter-hljs sql hljs
-- å‡è®¾è¡¨æœ‰5ä¸ªç´¢å¼•ï¼Œæ’å…¥ä¸€æ¡æ•°æ®ï¼š
INSERT INTO users (name, age, city, phone, email) 
VALUES ('å¼ ä¸‰', 25, 'åŒ—äº¬', '13800138000', 'zhangsan@example.com');

-- å®é™…å‘ç”Ÿï¼š
ä¸»æ•°æ®å†™å…¥ 1 æ¬¡
ç´¢å¼•1å†™å…¥ 1 æ¬¡
ç´¢å¼•2å†™å…¥ 1 æ¬¡
ç´¢å¼•3å†™å…¥ 1 æ¬¡
ç´¢å¼•4å†™å…¥ 1 æ¬¡
ç´¢å¼•5å†™å…¥ 1 æ¬¡

```

**æ€»å…±ï¼š6æ¬¡å†™å…¥ï¼æ¯åŠ ä¸€ä¸ªç´¢å¼•ï¼Œå†™å…¥å°±å¤šä¸€æ¬¡ã€‚**

### **2\. æ›´æ–°/åˆ é™¤å˜æ…¢**

```highlighter-hljs sql hljs
UPDATE users SET city = 'ä¸Šæµ·' WHERE id = 100;
-- å¦‚æœcityåˆ—æœ‰ç´¢å¼•ï¼Œéœ€è¦ï¼š1.åˆ é™¤æ—§ç´¢å¼• 2.æ’å…¥æ–°ç´¢å¼•
-- å¤šä¸ªç´¢å¼•æ—¶ï¼Œæ¯ä¸ªæ¶‰åŠåˆ°çš„ç´¢å¼•éƒ½è¦æ›´æ–°

```

## ğŸ’° ç´¢å¼•çš„"æˆæœ¬"åˆ†æ

### **ç©ºé—´æˆæœ¬**

```highlighter-hljs sql hljs
-- æŸ¥çœ‹ç´¢å¼•å ç”¨ç©ºé—´
SELECT 
    table_name,
    index_name,
    ROUND(index_length/1024/1024, 2) AS 'ç´¢å¼•å¤§å°(MB)',
    ROUND(data_length/1024/1024, 2) AS 'æ•°æ®å¤§å°(MB)',
    ROUND(index_length/data_length, 2) AS 'ç´¢å¼•/æ•°æ®æ¯”'
FROM information_schema.TABLES 
WHERE table_schema = 'your_db';

-- å…¸å‹æƒ…å†µï¼š
-- æ•°æ®ï¼š100MB
-- 1ä¸ªç´¢å¼•ï¼š20MB
-- 5ä¸ªç´¢å¼•ï¼š100MBï¼ˆå’ŒåŸå§‹æ•°æ®ä¸€æ ·å¤§ï¼ï¼‰

```

### **æ—¶é—´æˆæœ¬å¯¹æ¯”**

| æ“ä½œ      | æ— ç´¢å¼•   | 1ä¸ªç´¢å¼•  | 5ä¸ªç´¢å¼• |
| ------- | ----- | ----- | ---- |
| æ’å…¥1000æ¡ | 0.1ç§’  | 0.2ç§’  | 0.6ç§’ |
| æ›´æ–°100æ¡  | 0.05ç§’ | 0.1ç§’  | 0.4ç§’ |
| åˆ é™¤100æ¡  | 0.05ç§’ | 0.08ç§’ | 0.3ç§’ |

## ğŸš¨ ç´¢å¼•è¿‡å¤šçš„å±å®³

### **1\. ä¼˜åŒ–å™¨é€‰æ‹©å›°éš¾**

```highlighter-hljs sql hljs
-- å‡è®¾è¡¨æœ‰10ä¸ªç´¢å¼•ï¼ŒæŸ¥è¯¢ï¼š
SELECT * FROM users WHERE age > 20 AND city = 'åŒ—äº¬';

-- ä¼˜åŒ–å™¨å¯èƒ½é¢ä¸´é€‰æ‹©ï¼š
-- idx_age (age)
-- idx_city (city)  
-- idx_age_city (age, city)
-- idx_city_age (city, age)
-- ...ç­‰ç­‰

-- é€‰æ‹©è¿‡ç¨‹æ¶ˆè€—CPUï¼Œè¿˜å¯èƒ½é€‰é”™ç´¢å¼•ï¼

```

### **2\. é‡å¤/å†—ä½™ç´¢å¼•**

```highlighter-hljs sql hljs
-- å¸¸è§é‡å¤ç´¢å¼•ï¼š
CREATE INDEX idx_a ON users(a);
CREATE INDEX idx_a_b ON users(a, b);  -- idx_aæ˜¯å†—ä½™çš„ï¼

-- å†—ä½™ç´¢å¼•ï¼š
CREATE INDEX idx_b_a ON users(b, a);  -- å’Œidx_a_bé¡ºåºä¸åŒï¼Œå¯èƒ½éƒ½éœ€è¦
CREATE INDEX idx_a_b_c ON users(a, b, c);  -- åŒ…å«idx_a_bçš„åŠŸèƒ½

```

### **3\. å†…å­˜æµªè´¹**

```highlighter-hljs hljs undefined
MySQLç¼“å†²æ± å¤§å°æœ‰é™ï¼ˆæ¯”å¦‚4GBï¼‰

ç†æƒ³æƒ…å†µï¼š
æ•°æ®ç¼“å­˜ï¼š3GB
ç´¢å¼•ç¼“å­˜ï¼š1GB
æŸ¥è¯¢ï¼šå¿«é€Ÿ

ç´¢å¼•è¿‡å¤šæ—¶ï¼š
æ•°æ®ç¼“å­˜ï¼š2GB  
ç´¢å¼•ç¼“å­˜ï¼š2GBï¼ˆå¤§é‡ä¸å¸¸ç”¨çš„ç´¢å¼•å å†…å­˜ï¼‰
æŸ¥è¯¢ï¼šç»å¸¸éœ€è¦ä»ç£ç›˜è¯»æ•°æ®ï¼Œå˜æ…¢ï¼

```

## ğŸ” å¦‚ä½•åˆ¤æ–­ç´¢å¼•æ˜¯å¦è¿‡å¤šï¼Ÿ

### **å¥åº·æŒ‡æ ‡æ£€æŸ¥**

```highlighter-hljs sql hljs
-- 1. ç´¢å¼•ä¸æ•°æ®æ¯”ä¾‹
-- å¥åº·ï¼šç´¢å¼•å¤§å° < æ•°æ®å¤§å°
-- å±é™©ï¼šç´¢å¼•å¤§å° > æ•°æ®å¤§å°

-- 2. ç´¢å¼•æ•°é‡
-- å°å‹è¡¨ï¼ˆ<10ä¸‡è¡Œï¼‰ï¼š3-5ä¸ªç´¢å¼•
-- ä¸­å‹è¡¨ï¼ˆ10ä¸‡-1000ä¸‡ï¼‰ï¼š5-8ä¸ªç´¢å¼•  
-- å¤§å‹è¡¨ï¼ˆ>1000ä¸‡ï¼‰ï¼š8-12ä¸ªç´¢å¼•ï¼ˆéœ€ä¸¥æ ¼è¯„ä¼°ï¼‰

-- 3. ç´¢å¼•ä½¿ç”¨ç‡
SELECT 
    object_schema,
    object_name,
    index_name,
    rows_read,
    rows_inserted,
    rows_updated,
    rows_deleted
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE index_name IS NOT NULL
ORDER BY rows_read DESC;

-- å¦‚æœrows_readå¾ˆä½ï¼Œè¯´æ˜ç´¢å¼•å¾ˆå°‘è¢«ç”¨

```

### **æ‰¾å‡ºæ— ç”¨ç´¢å¼•**

```highlighter-hljs sql hljs
-- MySQL 8.0+ æŸ¥çœ‹æœªä½¿ç”¨ç´¢å¼•
SELECT * FROM sys.schema_unused_indexes;

-- æ‰‹åŠ¨åˆ†æï¼ˆæ‰€æœ‰ç‰ˆæœ¬é€‚ç”¨ï¼‰
SELECT 
    s.index_name,
    s.table_name,
    s.rows_selected,
    s.rows_inserted,
    s.rows_updated,
    s.rows_deleted,
    CASE 
        WHEN s.rows_selected < 1000 THEN 'è€ƒè™‘åˆ é™¤'
        WHEN s.rows_selected < 10000 THEN 'è§‚å¯Ÿ'
        ELSE 'ä¿ç•™'
    END AS recommendation
FROM (
    SELECT 
        OBJECT_NAME AS table_name,
        INDEX_NAME AS index_name,
        COUNT_READ AS rows_selected,
        COUNT_INSERT AS rows_inserted,
        COUNT_UPDATE AS rows_updated,
        COUNT_DELETE AS rows_deleted
    FROM performance_schema.table_io_waits_summary_by_index_usage
    WHERE OBJECT_SCHEMA = DATABASE()
) s
WHERE rows_selected = 0 
   OR (rows_selected < 100 AND rows_updated > 1000);

```

## ğŸ¯ æœ€ä½³ç´¢å¼•æ•°é‡ç­–ç•¥

### **æ ¹æ®ä¸šåŠ¡ç±»å‹å†³å®š**

```highlighter-hljs hljs undefined
OLTPç³»ç»Ÿï¼ˆåœ¨çº¿äº¤æ˜“ï¼Œé¢‘ç¹å†™ï¼‰ï¼š
  âœ… ç´¢å¼•è¦å°‘è€Œç²¾ï¼ˆ3-8ä¸ªï¼‰
  âœ… åªç»™é«˜é¢‘æŸ¥è¯¢å»ºç´¢å¼•
  âœ… å®šæœŸæ¸…ç†æ— ç”¨ç´¢å¼•

OLAPç³»ç»Ÿï¼ˆåˆ†ææŠ¥è¡¨ï¼Œé¢‘ç¹è¯»ï¼‰ï¼š
  âœ… ç´¢å¼•å¯ä»¥ç¨å¤šï¼ˆ8-15ä¸ªï¼‰
  âœ… è¦†ç›–å¤šç§æŸ¥è¯¢æ¨¡å¼
  âœ… ä½†è¦æ³¨æ„ç»´æŠ¤æˆæœ¬

```

### **ç´¢å¼•ä¼˜å…ˆçº§æ’åº**

```highlighter-hljs sql hljs
-- æŒ‰é‡è¦æ€§åˆ›å»ºç´¢å¼•ï¼š
1. ä¸»é”®ç´¢å¼•ï¼ˆå¿…é¡»æœ‰ï¼‰            -- â­â­â­â­â­
2. å”¯ä¸€çº¦æŸç´¢å¼•                  -- â­â­â­â­â­
3. é«˜é¢‘æŸ¥è¯¢çš„WHEREæ¡ä»¶åˆ—         -- â­â­â­â­
4. é«˜é¢‘æŸ¥è¯¢çš„JOINæ¡ä»¶åˆ—          -- â­â­â­â­  
5. é«˜é¢‘çš„ORDER BY/GROUP BYåˆ—     -- â­â­â­
6. è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰           -- â­â­â­
7. å…¨æ–‡ç´¢å¼•ï¼ˆæ–‡æœ¬æœç´¢ï¼‰           -- â­â­
8. ä½é€‰æ‹©æ€§åˆ—ç´¢å¼•ï¼ˆå¦‚æ€§åˆ«ï¼‰       -- â­ï¼ˆé€šå¸¸ä¸éœ€è¦ï¼‰

```

## ğŸ“ å®æˆ˜æ¡ˆä¾‹ï¼šç”µå•†ç³»ç»Ÿç´¢å¼•ä¼˜åŒ–

### **å•†å“è¡¨ä¼˜åŒ–å‰**

```highlighter-hljs sql hljs
-- æœ‰15ä¸ªç´¢å¼•ï¼
CREATE TABLE products (
    id INT PRIMARY KEY,
    name VARCHAR(200),
    category_id INT,
    price DECIMAL(10,2),
    stock INT,
    status TINYINT,
    created_time DATETIME,
    updated_time DATETIME,
    -- å„ç§å•åˆ—ç´¢å¼•
    INDEX idx_name (name),
    INDEX idx_category (category_id),
    INDEX idx_price (price),
    INDEX idx_stock (stock),
    INDEX idx_status (status),
    INDEX idx_created (created_time),
    INDEX idx_updated (updated_time),
    -- å„ç§ç»„åˆç´¢å¼•
    INDEX idx_cat_price (category_id, price),
    INDEX idx_cat_status (category_id, status),
    INDEX idx_price_status (price, status),
    -- è¿˜æœ‰é‡å¤å†—ä½™çš„...
    INDEX idx_name_part (name(20)),  -- å’Œidx_nameé‡å¤
    INDEX idx_cat_price_stock (category_id, price, stock)
);

```

**é—®é¢˜**ï¼šå†™å…¥æ…¢ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼Œå†…å­˜å ç”¨å¤§ã€‚

### **ä¼˜åŒ–å**

```highlighter-hljs sql hljs
-- ç²¾ç®€åˆ°6ä¸ªæ ¸å¿ƒç´¢å¼•
CREATE TABLE products (
    id INT PRIMARY KEY,
    name VARCHAR(200),
    category_id INT,
    price DECIMAL(10,2),
    stock INT,
    status TINYINT,
    created_time DATETIME,
    updated_time DATETIME,
    -- 1. é«˜é¢‘æŸ¥è¯¢ï¼šæŒ‰åˆ†ç±»+ä»·æ ¼æ’åº
    INDEX idx_cat_price_status (category_id, price, status),
    -- 2. é«˜é¢‘æŸ¥è¯¢ï¼šæŒ‰çŠ¶æ€+åˆ›å»ºæ—¶é—´
    INDEX idx_status_created (status, created_time),
    -- 3. åç§°æœç´¢ï¼ˆå‰ç¼€ç´¢å¼•ï¼‰
    INDEX idx_name (name(50)),
    -- 4. åº“å­˜é¢„è­¦
    INDEX idx_stock_status (stock, status),
    -- 5. æ—¶é—´èŒƒå›´æŸ¥è¯¢
    INDEX idx_created (created_time),
    -- 6. ç®¡ç†åå°å¤åˆæŸ¥è¯¢
    INDEX idx_cat_created (category_id, created_time)
);

```

**æ•ˆæœ**ï¼šå†™å…¥é€Ÿåº¦æå‡40%ï¼Œå†…å­˜å ç”¨å‡å°‘60%ï¼ŒæŸ¥è¯¢æ€§èƒ½åŸºæœ¬ä¸å˜ã€‚

## ğŸ› ï¸ ç´¢å¼•ç®¡ç†æœ€ä½³å®è·µ

### **1\. å®šæœŸå®¡è®¡**

```highlighter-hljs sql hljs
-- æ¯æœˆæ‰§è¡Œä¸€æ¬¡
-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT * FROM sys.schema_unused_indexes;

-- æ£€æŸ¥é‡å¤ç´¢å¼•
SELECT 
    a.table_name,
    a.index_name AS idx1,
    b.index_name AS idx2,
    a.column_name
FROM information_schema.statistics a
JOIN information_schema.statistics b 
    ON a.table_schema = b.table_schema
    AND a.table_name = b.table_name
    AND a.column_name = b.column_name
    AND a.seq_in_index = b.seq_in_index
    AND a.index_name != b.index_name
WHERE a.table_schema = DATABASE();

```

### **2\. ä½¿ç”¨ä¸å¯è§ç´¢å¼•æµ‹è¯•**

```highlighter-hljs sql hljs
-- MySQL 8.0+ åŠŸèƒ½
-- å…ˆè®©ç´¢å¼•ä¸å¯è§ï¼Œè§‚å¯Ÿå½±å“
ALTER TABLE users ALTER INDEX idx_test INVISIBLE;

-- è¿è¡Œä¸€æ®µæ—¶é—´ä¸šåŠ¡
-- å¦‚æœæ²¡å½±å“ï¼Œå†åˆ é™¤
DROP INDEX idx_test ON users;

```

### **3\. ç›‘æ§å†™å…¥æ€§èƒ½**

```highlighter-hljs sql hljs
-- ç›‘æ§ç´¢å¼•å¯¹å†™å…¥çš„å½±å“
SHOW GLOBAL STATUS LIKE 'Innodb_rows_inserted';
SHOW GLOBAL STATUS LIKE 'Innodb_rows_updated';
SHOW GLOBAL STATUS LIKE 'Innodb_rows_deleted';

-- è®¡ç®—ç´¢å¼•ç»´æŠ¤æˆæœ¬
-- å¦‚æœå‘ç°å†™å…¥æ€§èƒ½ä¸‹é™ï¼Œè€ƒè™‘å‡å°‘ç´¢å¼•

```

## ğŸ’¡ é»„é‡‘æ³•åˆ™

### **ç´¢å¼•åˆ›å»ºæ£€æŸ¥æ¸…å•**

âœ… è¿™ä¸ªæŸ¥è¯¢æ¯å¤©æ‰§è¡Œå¤šå°‘æ¬¡ï¼Ÿï¼ˆ>100æ¬¡è€ƒè™‘ç´¢å¼•ï¼‰  
âœ… è¿™ä¸ªç´¢å¼•èƒ½è¦†ç›–å¤šä¸ªæŸ¥è¯¢å—ï¼Ÿ  
âœ… è¡¨çš„ä¸»è¦æ“ä½œæ˜¯è¯»è¿˜æ˜¯å†™ï¼Ÿ  
âœ… ç´¢å¼•åˆ—çš„é€‰æ‹©æ€§é«˜å—ï¼Ÿï¼ˆ>10%ï¼‰  
âœ… å·²æœ‰ç±»ä¼¼ç´¢å¼•å—ï¼Ÿï¼ˆé¿å…é‡å¤ï¼‰  
âœ… ç´¢å¼•ä¼šå ç”¨å¤šå°‘ç©ºé—´ï¼Ÿ  
âœ… ç»´æŠ¤æˆæœ¬èƒ½æ¥å—å—ï¼Ÿ

### **ç®€å•å†³ç­–æµç¨‹**

```highlighter-hljs hljs markdown
æ–°æŸ¥è¯¢éœ€è¦ç´¢å¼•å—ï¼Ÿ
    â†“
æ¯å¤©æ‰§è¡Œè¶…è¿‡100æ¬¡ï¼Ÿ â†’ å¦ â†’ ä¸éœ€è¦
    â†“æ˜¯
æœ‰ç±»ä¼¼ç´¢å¼•å—ï¼Ÿ â†’ æ˜¯ â†’ å¤ç”¨ç°æœ‰ç´¢å¼•
    â†“å¦  
é€‰æ‹©æ€§ > 10%ï¼Ÿ â†’ å¦ â†’ å¯èƒ½ä¸éœ€è¦
    â†“æ˜¯
è¡¨å†™å…¥é¢‘ç¹å—ï¼Ÿ â†’ æ˜¯ â†’ è°¨æ…è¯„ä¼°
    â†“å¦
åˆ›å»ºç´¢å¼•ï¼Œç›‘æ§æ•ˆæœ

```

## ğŸ“ˆ æ€»ç»“ï¼šç´¢å¼•æ•°é‡çš„å¹³è¡¡ç‚¹

| åœºæ™¯           | å»ºè®®ç´¢å¼•æ•° | ç†ç”±        |
| ------------ | ----- | --------- |
| é…ç½®/å­—å…¸è¡¨ï¼ˆ<1ä¸‡è¡Œï¼‰ | 0-2ä¸ª  | æ•°æ®å°‘ï¼Œå…¨è¡¨æ‰«æå¿« |
| ç”¨æˆ·è¡¨ï¼ˆ10-100ä¸‡ï¼‰ | 3-6ä¸ª  | å¹³è¡¡è¯»å†™      |
| è®¢å•è¡¨ï¼ˆ>1000ä¸‡ï¼‰  | 5-8ä¸ª  | å†™é¢‘ç¹ï¼Œéœ€è°¨æ…   |
| æ—¥å¿—/æµæ°´è¡¨ï¼ˆåªè¯»ï¼‰   | å¯ç¨å¤š   | ä¸»è¦æ˜¯æŸ¥è¯¢ï¼Œå†™å°‘  |
| æ•°æ®ä»“åº“è¡¨        | 6-12ä¸ª | å¤æ‚åˆ†ææŸ¥è¯¢å¤š   |

**è®°ä½**ï¼š  
ğŸ”¹ **æ¯ä¸ªç´¢å¼•éƒ½æ˜¯è´Ÿå€º**ï¼ˆç»´æŠ¤æˆæœ¬ï¼‰  
ğŸ”¹ **åªæœ‰é«˜é¢‘æŸ¥è¯¢æ‰å€¼å¾—å»ºç´¢å¼•**  
ğŸ”¹ **å®šæœŸæ¸…ç†å°±åƒå®šæœŸå¤§æ‰«é™¤**  
ğŸ”¹ **è´¨é‡ > æ•°é‡**ï¼ˆä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„å¤åˆç´¢å¼•é¡¶ä¸‰ä¸ªå•åˆ—ç´¢å¼•ï¼‰

**æœ€ç»ˆå»ºè®®**ï¼šä»æ ¸å¿ƒæŸ¥è¯¢å¼€å§‹ï¼ŒæŒ‰éœ€åˆ›å»ºï¼Œå®šæœŸè¯„ä¼°ï¼Œä¿æŒç²¾ç®€ï¼
